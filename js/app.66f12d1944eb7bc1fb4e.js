document.addEventListener("DOMContentLoaded",function(){var e=new Framework7({el:"#app",name:"Sweet Dreams",theme:"ios",panel:{swipe:!0},routes:[{path:"/",pageName:"home"},{path:"/history/",url:"pages/history.html",on:{pageAfterIn:function(e,t){"function"==typeof loadHistory&&loadHistory()}}},{path:"/info/",url:"pages/info.html",on:{pageInit:function(e,t){console.log("Info page initialized")},pageBeforeIn:function(e,t){console.log("Info page before in")}}},{path:"/settings/",url:"pages/settings.html",on:{pageInit:function(n,i){$(),function(){const n=M();if(n>5){const e=document.querySelector("#daysList ul");for(let i=6;i<=n;i++){const n=document.createElement("li");n.className="item-divider",n.textContent=`Day ${i}`;const o=document.createElement("li");o.className="item-content item-input",o.innerHTML=`\n        <div class="item-inner">\n          <div class="item-title item-label">Check intervals (minutes)</div>\n          <div class="item-input-wrap">\n            <input type="text" id="day${i}" placeholder="4, 5, 6, 6" value="${t[i]?t[i].checks.join(", "):""}">\n          </div>\n        </div>\n      `,e.appendChild(n),e.appendChild(o)}}const i=document.getElementById("settingsForm");i&&i.addEventListener("submit",function(n){n.preventDefault(),function(){const n={};document.querySelectorAll('[id^="day"]').forEach(e=>{const t=e.id.match(/day(\d+)/);if(t){const i=parseInt(t[1]),o=e.value.split(",").map(e=>{const t=parseFloat(e.trim());return isNaN(t)?0:t}).filter(e=>e>0);o.length>0&&(n[i]={checks:o})}}),localStorage.setItem("customIntervalConfig",JSON.stringify(n)),Object.keys(t).forEach(e=>{isNaN(Number(e))||delete t[e]}),Object.assign(t,n),R(),e.dialog.alert("Settings saved successfully!","Success")}()});const o=document.getElementById("addDayBtn");o&&o.addEventListener("click",function(e){e.preventDefault(),function(){const e=document.querySelector("#daysList ul"),t=M()+1,n=document.createElement("li");n.className="item-divider",n.textContent=`Day ${t}`;const i=document.createElement("li");i.className="item-content item-input",i.innerHTML=`\n    <div class="item-inner">\n      <div class="item-title item-label">Check intervals (minutes)</div>\n      <div class="item-input-wrap">\n        <input type="text" id="day${t}" placeholder="4, 5, 6, 6" value="">\n      </div>\n    </div>\n  `,e.appendChild(n),e.appendChild(i)}()});const a=document.getElementById("resetDefaultsBtn");a&&a.addEventListener("click",function(n){n.preventDefault(),e.dialog.confirm("Are you sure you want to reset to default settings?","Reset Settings",function(){localStorage.removeItem("customIntervalConfig"),Object.keys(t).forEach(e=>{isNaN(Number(e))||delete t[e]}),Object.assign(t,{1:{checks:[2,2,3,3]},2:{checks:[2,3,3,4]},3:{checks:[3,4,4,5]},4:{checks:[3,4,5,5]},5:{checks:[4,5,6,6]}}),e.dialog.alert("Settings reset to defaults!","Reset Complete"),window.location.reload()})});const s=document.getElementById("testNotificationBtn");s&&s.addEventListener("click",function(t){t.preventDefault(),"Notification"in window?"granted"===Notification.permission?v("🔔 Test Notification","Notifications are working! You'll get alerts when your timer is ready."):"default"===Notification.permission?e.dialog.alert('Please enable notifications first using the "Enable Notifications" button.',"Notifications Not Enabled"):e.dialog.alert("Notifications are blocked. Please enable them in your browser settings.","Notifications Blocked"):e.dialog.alert("This browser doesn't support notifications.","Not Supported")});const r=document.getElementById("enableNotificationsBtn");r&&r.addEventListener("click",function(t){t.preventDefault(),Notification.requestPermission().then(t=>{console.log("Notification permission result:",t),"granted"===t?e.toast.create({text:"✅ Notifications enabled! You'll get alerts when timer is ready.",position:"center",closeTimeout:3e3}).open():"denied"===t&&e.toast.create({text:"⚠️ Notifications blocked. Enable in browser settings for timer alerts.",position:"center",closeTimeout:5e3}).open()})})}()}}}],on:{init:function(){console.log("Framework7 app initialized"),setTimeout(()=>{const e=document.querySelector(".view-main"),t=document.querySelector(".view-main .navbar");e&&(e.style.display="block",e.style.visibility="visible",e.style.opacity="1"),t&&(t.style.display="block",t.style.visibility="visible",t.style.opacity="1"),console.log("Main view and navbar visibility forced")},10)}}});console.log("Manual view creation disabled - testing auto-init"),e.on("pageInit",function(){const t=document.querySelector('a[href="/"].panel-close');t&&t.addEventListener("click",function(t){t.preventDefault(),e.views.main.router.navigate("/",{reloadCurrent:!0,clearPreviousHistory:!1})})});const t={1:{checks:[2,2,3,3]},2:{checks:[2,3,3,4]},3:{checks:[3,4,4,5]},4:{checks:[3,4,5,5]},5:{checks:[4,5,6,6]}};let n={isRunning:!1,isPaused:!1,currentTime:0,currentCheck:0,currentDay:1,interval:null,startTime:null,checkStartTime:null,sessionLog:[]};const i=document.getElementById("timerDisplay"),o=document.getElementById("startBtn"),a=document.getElementById("stopBtn"),s=document.getElementById("checkBtn"),r=document.getElementById("resetQuietBtn"),c=document.getElementById("daySelect"),l=document.getElementById("currentCheck"),d=document.getElementById("waitTime"),u=document.getElementById("sessionLog");function m(){const e=Math.floor(n.currentTime/60),t=n.currentTime%60;i.textContent=`${e.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`}function g(){let e=n.currentDay;if(!t[e]){const n=Object.keys(t).map(Number).filter(e=>!isNaN(e));e=Math.max(...n)}const i=t[e],o=n.currentCheck;return o<i.checks.length?i.checks[o]:i.checks[i.checks.length-1]}function y(e){const t=new Date,i={time:`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}:${String(t.getSeconds()).padStart(2,"0")}`,message:e,timestamp:t.getTime()};n.sessionLog.push(i),p(),function(){const e=JSON.parse(localStorage.getItem("sleepSessions")||"[]"),t={date:(new Date).toISOString(),day:n.currentDay,log:n.sessionLog,startTime:n.startTime},i=e.findIndex(e=>new Date(e.date).toDateString()===(new Date).toDateString());i>=0?e[i]=t:e.push(t),localStorage.setItem("sleepSessions",JSON.stringify(e))}()}function p(){0===n.sessionLog.length?u.innerHTML='\n      <div class="empty-state">\n        <i class="icon f7-icons">moon_zzz</i>\n        <p>Press "Crying" when baby starts crying</p>\n      </div>\n    ':(u.innerHTML=n.sessionLog.map(e=>`<div class="log-entry">\n        <span class="time">${e.time}</span> - ${e.message}\n      </div>`).join(""),u.scrollTop=u.scrollHeight)}function f(){if(n.isRunning){const e={...n,savedAt:Date.now()};localStorage.setItem("timerState",JSON.stringify(e))}else localStorage.removeItem("timerState")}function v(e,t){if("Notification"in window&&"granted"===Notification.permission){const n=new Notification(e,{body:t,icon:"/sweet-dreams/icons/icon.svg",badge:"/sweet-dreams/icons/icon.svg",tag:"sleep-timer",requireInteraction:!0});setTimeout(()=>n.close(),1e4)}}function h(){if("visible"!==document.visibilityState){if("serviceWorker"in navigator&&n.isRunning){const e=60*g();navigator.serviceWorker.ready.then(t=>{t.active.postMessage({type:"START_PERSISTENT_TIMER",data:{currentTime:n.currentTime,targetTime:e,checkNumber:n.currentCheck+1,dayNumber:n.currentDay,startTime:Date.now()-1e3*n.currentTime}})})}}else console.log("App is visible, skipping persistent notification")}function S(){"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(e=>{e.active.postMessage({type:"STOP_PERSISTENT_TIMER"})})}let k=null;async function T(){try{"wakeLock"in navigator&&(k=await navigator.wakeLock.request("screen"),console.log("Screen wake lock acquired"),k.addEventListener("release",()=>{console.log("Screen wake lock was released"),n.isRunning&&"visible"===document.visibilityState&&T()}))}catch(e){console.log(`Wake Lock error: ${e.name}, ${e.message}`)}}async function b(){k&&(await k.release(),k=null,console.log("Screen wake lock released"))}function w(){"mediaSession"in navigator&&(navigator.mediaSession.metadata=new MediaMetadata({title:`Sleep Timer - Check ${n.currentCheck+1}`,artist:`Day ${n.currentDay} Training`,album:"Sweet Dreams"}),navigator.mediaSession.setActionHandler("play",()=>{n.isRunning||C()}),navigator.mediaSession.setActionHandler("pause",()=>{n.isRunning&&E()}))}function I(){if("mediaSession"in navigator&&n.isRunning){const e=g(),t=Math.max(0,60*e-n.currentTime),i=Math.floor(t/60),o=t%60;navigator.mediaSession.metadata=new MediaMetadata({title:t>0?`${i}:${o.toString().padStart(2,"0")} remaining`:"✓ Ready to check!",artist:`Check ${n.currentCheck+1} - Day ${n.currentDay}`,album:"Sweet Dreams Sleep Timer"}),navigator.mediaSession.setPositionState&&navigator.mediaSession.setPositionState({duration:60*e,playbackRate:1,position:n.currentTime})}}function D(){"mediaSession"in navigator&&(navigator.mediaSession.metadata=null,navigator.mediaSession.setActionHandler("play",null),navigator.mediaSession.setActionHandler("pause",null))}function C(){n.isRunning||o.disabled||(o.disabled=!0,setTimeout(()=>{o.disabled=!1},500),n.isRunning=!0,0===n.sessionLog.length?(n.currentTime=0,n.currentCheck=0,n.checkStartTime=Date.now(),n.startTime=(new Date).toISOString(),y("Baby started crying - Day "+n.currentDay)):(n.currentTime=0,y("Baby started crying again")),o.style.display="none",a.style.display="block",r.style.display="block",s.disabled=!1,L(),n.interval=setInterval(()=>{const e=Math.floor((Date.now()-n.checkStartTime)/1e3);n.currentTime=e,m(),f(),I();const t=g(),i=60*t,o=i-n.currentTime;60===o?v("⏰ 1 Minute Left",`Check ${n.currentCheck+1} - 1 minute remaining`):30===o?v("⏰ 30 Seconds Left",`Check ${n.currentCheck+1} - 30 seconds remaining`):10===o&&v("⏰ 10 Seconds Left",`Check ${n.currentCheck+1} - Get ready to check!`),n.currentTime>=i&&(s.classList.add("color-orange"),n.currentTime===i&&v("⏰ Sleep Timer Ready",`Check ${n.currentCheck+1} ready! Wait time of ${t} minutes reached.`))},1e3),T(),w(),"visible"!==document.visibilityState&&h())}function E(){n.isRunning&&(clearInterval(n.interval),n.isRunning=!1,n.currentTime=0,s.classList.remove("color-orange"),S(),b(),D(),o.style.display="block",a.style.display="none",y(`Baby stopped crying - Timer paused at check ${n.currentCheck+1}`),m(),f())}function N(t){s.disabled=!0,s.classList.remove("color-orange"),y(`Check ${n.currentCheck+1} completed (waited ${t} min)`);let i,r=60;setTimeout(()=>{const t=e.dialog.create({title:"Comfort Time",text:'<div style="text-align: center; padding: 20px;"><div style="font-size: 48px; font-weight: bold; color: var(--f7-theme-color);" id="comfort-timer">1:00</div><div style="margin-top: 10px;">Maximum comfort time</div></div>',buttons:[{text:"Done",bold:!0,onClick:function(){clearInterval(i)}}],on:{opened:function(){i=setInterval(()=>{r--;const e=Math.floor(r/60),n=r%60,o=document.getElementById("comfort-timer");o&&(o.textContent=`${e}:${n.toString().padStart(2,"0")}`),r<=0&&(clearInterval(i),t.close())},1e3)},closed:function(){clearInterval(i),n.currentCheck++,n.currentTime=0,L(),y("Room left after check"),n.isRunning&&(clearInterval(n.interval),n.isRunning=!1,S(),o.style.display="block",a.style.display="none",s.disabled=!0,s.classList.remove("color-orange"),m(),f())}}});t.open()},100)}function L(){l.textContent=n.currentCheck+1,d.textContent=g()}function $(){const e=localStorage.getItem("customIntervalConfig");if(e){const n=JSON.parse(e);Object.assign(t,n);const i=M();for(let e=1;e<=i;e++){const t=document.getElementById(`day${e}`);t&&n[e]&&(t.value=n[e].checks.join(", "))}}}function M(){const e=Object.keys(t).map(Number).filter(e=>!isNaN(e));return e.length>0?Math.max(...e):5}function B(e){if(!e)return;const t=e.value,n=M();e.innerHTML="";for(let t=1;t<=n;t++){const n=document.createElement("option");n.value=t,n.textContent=`Day ${t}`,e.appendChild(n)}e.value=t&&t<=n?t:1}function R(){B(document.getElementById("daySelect")),B(document.getElementById("splashDaySelect"))}document.addEventListener("visibilitychange",()=>{if("visible"===document.visibilityState){if(S(),n.isRunning&&(T(),n.checkStartTime)){const e=Math.floor((Date.now()-n.checkStartTime)/1e3);n.currentTime=e,m(),I()}}else n.isRunning&&h(),b()}),"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",e=>{"STOP_TIMER_FROM_NOTIFICATION"===e.data.type&&E()}),o.addEventListener("click",C),a.addEventListener("click",E),s.addEventListener("click",function(){const t=g(),i=Math.floor(n.currentTime/60);n.currentTime<60*t?e.dialog.confirm(`You've only waited ${i} minutes. Recommended wait time is ${t} minutes. Check anyway?`,"Early Check Warning",()=>{N(i)}):N(i)}),r.addEventListener("click",function(){n.interval&&clearInterval(n.interval),n.isRunning=!1,S(),b(),D(),e.toast.create({text:'<div style="text-align: center;"><i class="icon f7-icons" style="font-size: 48px;">moon_zzz_fill</i><br>Sweet dreams! 😴</div>',position:"center",closeTimeout:3e3}).open(),n.sessionLog.length>0&&y("Session completed - Baby sleeping"),n.currentTime=0,n.currentCheck=0,n.sessionLog=[],o.style.display="block",a.style.display="none",r.style.display="none",s.disabled=!0,s.classList.remove("color-orange"),m(),L(),p(),f()}),c.addEventListener("change",e=>{n.currentDay=parseInt(e.target.value),L(),localStorage.setItem("lastTrainingDay",JSON.stringify({day:n.currentDay,date:(new Date).toISOString()})),n.isRunning||(n.sessionLog=[],p())}),m(),L(),p(),function(){const e=localStorage.getItem("timerState");if(e){const t=JSON.parse(e);if(Math.floor((Date.now()-t.savedAt)/1e3),n.currentDay=t.currentDay||1,n.currentCheck=t.currentCheck||0,n.sessionLog=t.sessionLog||[],c.value=n.currentDay.toString(),L(),p(),t.isRunning&&t.checkStartTime){const e=Math.floor((Date.now()-t.checkStartTime)/1e3);n.currentTime=e,n.checkStartTime=t.checkStartTime,n.startTime=t.startTime,n.isRunning=!0,o.style.display="none",a.style.display="block",r.style.display="block",s.disabled=!1;const i=60*g();n.currentTime>=i&&s.classList.add("color-orange"),m(),n.interval=setInterval(()=>{const e=Math.floor((Date.now()-n.checkStartTime)/1e3);n.currentTime=e,m(),f(),I();const t=g(),i=60*t,o=i-n.currentTime;60===o?v("⏰ 1 Minute Left",`Check ${n.currentCheck+1} - 1 minute remaining`):30===o?v("⏰ 30 Seconds Left",`Check ${n.currentCheck+1} - 30 seconds remaining`):10===o&&v("⏰ 10 Seconds Left",`Check ${n.currentCheck+1} - Get ready to check!`),n.currentTime>=i&&(s.classList.add("color-orange"),n.currentTime===i&&v("⏰ Sleep Timer Ready",`Check ${n.currentCheck+1} ready! Wait time of ${t} minutes reached.`))},1e3),T(),w(),"visible"!==document.visibilityState&&h()}}else{const e=JSON.parse(localStorage.getItem("lastTrainingDay")||"{}");e.day&&(n.currentDay=e.day,c.value=n.currentDay.toString())}}(),$(),R(),function(){if("serviceWorker"in navigator){const e=(window.location.hostname,"./sw.js");navigator.serviceWorker.register(e).then(e=>{console.log("Service Worker registered:",e)}).catch(e=>{console.error("Service Worker registration failed:",e)})}!function(){if(!("Notification"in window))return void console.log("This browser does not support notifications");const e=Notification.permission;console.log("Notification permission status:",e),"denied"===e&&console.log("Notifications previously denied")}()}(),setTimeout(()=>{const e=document.querySelector(".view-main");e&&(e.style.visibility="visible",console.log("Main view visibility ensured"))},100),setTimeout(()=>{if(!n.isRunning){let e=0;const t=()=>{document.getElementById("splash-modal")?function(){const e=JSON.parse(localStorage.getItem("lastTrainingDay")||"{}"),t=document.getElementById("splash-modal");if(!t)return void console.log("Splash modal not found, skipping");const i=document.getElementById("splashDaySelect"),o=document.getElementById("dayHint"),a=document.getElementById("startAppBtn");if(i&&o&&a){if(e.date){const t=new Date(e.date),a=new Date,s=Math.floor((a-t)/864e5);let r=e.day||1;s>=1&&r<5&&(r=Math.min(r+s,5)),i.value=r,n.currentDay=r,o.innerHTML=0===s?`<small>Continuing from today (Day ${e.day})</small>`:1===s?`<small>Yesterday was Day ${e.day}, suggesting Day ${r}</small>`:`<small>Last session was ${s} days ago (Day ${e.day})</small>`}else o.innerHTML="<small>First time? Start with Day 1</small>";i.addEventListener("change",e=>{n.currentDay=parseInt(e.target.value);const t=document.getElementById("daySelect");t&&(t.value=e.target.value,L())}),a.addEventListener("click",()=>{localStorage.setItem("lastTrainingDay",JSON.stringify({day:n.currentDay,date:(new Date).toISOString()})),t.style.display="none"}),t.style.display="block"}else console.log("Splash modal elements not found, skipping")}():e<10?(e++,console.log(`Splash modal not found, attempt ${e}/10`),setTimeout(t,100)):console.log("Splash modal not found after 10 attempts, skipping")};t()}},1e3)});