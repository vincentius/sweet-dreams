document.addEventListener("DOMContentLoaded",function(){var e=new Framework7({el:"#app",name:"Sweet Dreams",theme:"ios",panel:{swipe:!0},routes:[{path:"/",pageName:"home"},{path:"/history/",url:"pages/history.html",on:{pageAfterIn:function(e,t){"function"==typeof loadHistory&&loadHistory()}}},{path:"/info/",url:"pages/info.html",on:{pageInit:function(e,t){console.log("Info page initialized")},pageBeforeIn:function(e,t){console.log("Info page before in")}}},{path:"/settings/",url:"pages/settings.html",on:{pageInit:function(n,i){T(),function(){const n=w();if(n>5){const e=document.querySelector("#daysList ul");for(let i=6;i<=n;i++){const n=document.createElement("li");n.className="item-divider",n.textContent=`Day ${i}`;const o=document.createElement("li");o.className="item-content item-input",o.innerHTML=`\n        <div class="item-inner">\n          <div class="item-title item-label">Check intervals (minutes)</div>\n          <div class="item-input-wrap">\n            <input type="text" id="day${i}" placeholder="4, 5, 6, 6" value="${t[i]?t[i].checks.join(", "):""}">\n          </div>\n        </div>\n      `,e.appendChild(n),e.appendChild(o)}}const i=document.getElementById("settingsForm");i&&i.addEventListener("submit",function(n){n.preventDefault(),function(){const n={};document.querySelectorAll('[id^="day"]').forEach(e=>{const t=e.id.match(/day(\d+)/);if(t){const i=parseInt(t[1]),o=e.value.split(",").map(e=>{const t=parseFloat(e.trim());return isNaN(t)?0:t}).filter(e=>e>0);o.length>0&&(n[i]={checks:o})}}),localStorage.setItem("customIntervalConfig",JSON.stringify(n)),Object.keys(t).forEach(e=>{isNaN(Number(e))||delete t[e]}),Object.assign(t,n),N(),e.dialog.alert("Settings saved successfully!","Success")}()});const o=document.getElementById("addDayBtn");o&&o.addEventListener("click",function(e){e.preventDefault(),function(){const e=document.querySelector("#daysList ul"),t=w()+1,n=document.createElement("li");n.className="item-divider",n.textContent=`Day ${t}`;const i=document.createElement("li");i.className="item-content item-input",i.innerHTML=`\n    <div class="item-inner">\n      <div class="item-title item-label">Check intervals (minutes)</div>\n      <div class="item-input-wrap">\n        <input type="text" id="day${t}" placeholder="4, 5, 6, 6" value="">\n      </div>\n    </div>\n  `,e.appendChild(n),e.appendChild(i)}()});const s=document.getElementById("resetDefaultsBtn");s&&s.addEventListener("click",function(n){n.preventDefault(),e.dialog.confirm("Are you sure you want to reset to default settings?","Reset Settings",function(){localStorage.removeItem("customIntervalConfig"),Object.keys(t).forEach(e=>{isNaN(Number(e))||delete t[e]}),Object.assign(t,{1:{checks:[2,2,3,3]},2:{checks:[2,3,3,4]},3:{checks:[3,4,4,5]},4:{checks:[3,4,5,5]},5:{checks:[4,5,6,6]}}),e.dialog.alert("Settings reset to defaults!","Reset Complete"),window.location.reload()})});const a=document.getElementById("testNotificationBtn");a&&a.addEventListener("click",function(t){t.preventDefault(),"Notification"in window?"granted"===Notification.permission?v("🔔 Test Notification","Notifications are working! You'll get alerts when your timer is ready."):"default"===Notification.permission?e.dialog.alert('Please enable notifications first using the "Enable Notifications" button.',"Notifications Not Enabled"):e.dialog.alert("Notifications are blocked. Please enable them in your browser settings.","Notifications Blocked"):e.dialog.alert("This browser doesn't support notifications.","Not Supported")});const r=document.getElementById("enableNotificationsBtn");r&&r.addEventListener("click",function(t){t.preventDefault(),Notification.requestPermission().then(t=>{console.log("Notification permission result:",t),"granted"===t?e.toast.create({text:"✅ Notifications enabled! You'll get alerts when timer is ready.",position:"center",closeTimeout:3e3}).open():"denied"===t&&e.toast.create({text:"⚠️ Notifications blocked. Enable in browser settings for timer alerts.",position:"center",closeTimeout:5e3}).open()})})}()}}}],on:{init:function(){console.log("Framework7 app initialized"),setTimeout(()=>{const e=document.querySelector(".view-main"),t=document.querySelector(".view-main .navbar");e&&(e.style.display="block",e.style.visibility="visible",e.style.opacity="1"),t&&(t.style.display="block",t.style.visibility="visible",t.style.opacity="1"),console.log("Main view and navbar visibility forced")},10)}}});console.log("Manual view creation disabled - testing auto-init"),e.on("pageInit",function(){const t=document.querySelector('a[href="/"].panel-close');t&&t.addEventListener("click",function(t){t.preventDefault(),e.views.main.router.navigate("/",{reloadCurrent:!0,clearPreviousHistory:!1})})});const t={1:{checks:[2,2,3,3]},2:{checks:[2,3,3,4]},3:{checks:[3,4,4,5]},4:{checks:[3,4,5,5]},5:{checks:[4,5,6,6]}};let n={isRunning:!1,isPaused:!1,currentTime:0,currentCheck:0,currentDay:1,interval:null,startTime:null,checkStartTime:null,sessionLog:[]};const i=document.getElementById("timerDisplay"),o=document.getElementById("startBtn"),s=document.getElementById("stopBtn"),a=document.getElementById("checkBtn"),r=document.getElementById("resetQuietBtn"),c=document.getElementById("daySelect"),l=document.getElementById("currentCheck"),d=document.getElementById("waitTime"),m=document.getElementById("sessionLog");function u(){const e=Math.floor(n.currentTime/60),t=n.currentTime%60;i.textContent=`${e.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`}function g(){let e=n.currentDay;if(!t[e]){const n=Object.keys(t).map(Number).filter(e=>!isNaN(e));e=Math.max(...n)}const i=t[e],o=n.currentCheck;return o<i.checks.length?i.checks[o]:i.checks[i.checks.length-1]}function y(e){const t=new Date,i={time:`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}:${String(t.getSeconds()).padStart(2,"0")}`,message:e,timestamp:t.getTime()};n.sessionLog.push(i),p(),function(){const e=JSON.parse(localStorage.getItem("sleepSessions")||"[]"),t={date:(new Date).toISOString(),day:n.currentDay,log:n.sessionLog,startTime:n.startTime},i=e.findIndex(e=>new Date(e.date).toDateString()===(new Date).toDateString());i>=0?e[i]=t:e.push(t),localStorage.setItem("sleepSessions",JSON.stringify(e))}()}function p(){0===n.sessionLog.length?m.innerHTML='\n      <div class="empty-state">\n        <i class="icon f7-icons">moon_zzz</i>\n        <p>Press "Crying" when baby starts crying</p>\n      </div>\n    ':(m.innerHTML=n.sessionLog.map(e=>`<div class="log-entry">\n        <span class="time">${e.time}</span> - ${e.message}\n      </div>`).join(""),m.scrollTop=m.scrollHeight)}function f(){if(n.isRunning){const e={...n,savedAt:Date.now()};localStorage.setItem("timerState",JSON.stringify(e))}else localStorage.removeItem("timerState")}function v(e,t){if("Notification"in window&&"granted"===Notification.permission){const n=new Notification(e,{body:t,icon:"/sweet-dreams/icons/icon.svg",badge:"/sweet-dreams/icons/icon.svg",tag:"sleep-timer",requireInteraction:!0});setTimeout(()=>n.close(),1e4)}}function h(){if("serviceWorker"in navigator&&n.isRunning){const e=60*g();navigator.serviceWorker.ready.then(t=>{t.active.postMessage({type:"START_PERSISTENT_TIMER",data:{currentTime:n.currentTime,targetTime:e,checkNumber:n.currentCheck+1,dayNumber:n.currentDay,startTime:Date.now()}})})}}function S(){"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(e=>{e.active.postMessage({type:"STOP_PERSISTENT_TIMER"})})}function k(){n.isRunning&&(clearInterval(n.interval),n.isRunning=!1,n.currentTime=0,a.classList.remove("color-orange"),S(),o.style.display="block",s.style.display="none",y(`Baby stopped crying - Timer paused at check ${n.currentCheck+1}`),u(),f())}function b(t){a.disabled=!0,a.classList.remove("color-orange"),y(`Check ${n.currentCheck+1} completed (waited ${t} min)`);let i,r=60;setTimeout(()=>{const t=e.dialog.create({title:"Comfort Time",text:'<div style="text-align: center; padding: 20px;"><div style="font-size: 48px; font-weight: bold; color: var(--f7-theme-color);" id="comfort-timer">1:00</div><div style="margin-top: 10px;">Maximum comfort time</div></div>',buttons:[{text:"Done",bold:!0,onClick:function(){clearInterval(i)}}],on:{opened:function(){i=setInterval(()=>{r--;const e=Math.floor(r/60),n=r%60,o=document.getElementById("comfort-timer");o&&(o.textContent=`${e}:${n.toString().padStart(2,"0")}`),r<=0&&(clearInterval(i),t.close())},1e3)},closed:function(){clearInterval(i),n.currentCheck++,n.currentTime=0,I(),y("Room left after check"),n.isRunning&&(clearInterval(n.interval),n.isRunning=!1,S(),o.style.display="block",s.style.display="none",a.disabled=!0,a.classList.remove("color-orange"),u(),f())}}});t.open()},100)}function I(){l.textContent=n.currentCheck+1,d.textContent=g()}function T(){const e=localStorage.getItem("customIntervalConfig");if(e){const n=JSON.parse(e);Object.assign(t,n);const i=w();for(let e=1;e<=i;e++){const t=document.getElementById(`day${e}`);t&&n[e]&&(t.value=n[e].checks.join(", "))}}}function w(){const e=Object.keys(t).map(Number).filter(e=>!isNaN(e));return e.length>0?Math.max(...e):5}function E(e){if(!e)return;const t=e.value,n=w();e.innerHTML="";for(let t=1;t<=n;t++){const n=document.createElement("option");n.value=t,n.textContent=`Day ${t}`,e.appendChild(n)}e.value=t&&t<=n?t:1}function N(){E(document.getElementById("daySelect")),E(document.getElementById("splashDaySelect"))}"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",e=>{"STOP_TIMER_FROM_NOTIFICATION"===e.data.type&&k()}),o.addEventListener("click",function(){n.isRunning||o.disabled||(o.disabled=!0,setTimeout(()=>{o.disabled=!1},500),n.isRunning=!0,0===n.sessionLog.length?(n.currentTime=0,n.currentCheck=0,n.checkStartTime=Date.now(),n.startTime=(new Date).toISOString(),y("Baby started crying - Day "+n.currentDay)):(n.currentTime=0,y("Baby started crying again")),o.style.display="none",s.style.display="block",r.style.display="block",a.disabled=!1,I(),n.interval=setInterval(()=>{n.currentTime++,u(),f();const e=g(),t=60*e;n.currentTime>=t&&(a.classList.add("color-orange"),n.currentTime===t&&v("⏰ Sleep Timer Ready",`Check ${n.currentCheck+1} ready! Wait time of ${e} minutes reached.`))},1e3),h())}),s.addEventListener("click",k),a.addEventListener("click",function(){const t=g(),i=Math.floor(n.currentTime/60);n.currentTime<60*t?e.dialog.confirm(`You've only waited ${i} minutes. Recommended wait time is ${t} minutes. Check anyway?`,"Early Check Warning",()=>{b(i)}):b(i)}),r.addEventListener("click",function(){n.interval&&clearInterval(n.interval),n.isRunning=!1,S(),e.toast.create({text:'<div style="text-align: center;"><i class="icon f7-icons" style="font-size: 48px;">moon_zzz_fill</i><br>Sweet dreams! 😴</div>',position:"center",closeTimeout:3e3}).open(),n.sessionLog.length>0&&y("Session completed - Baby sleeping"),n.currentTime=0,n.currentCheck=0,n.sessionLog=[],o.style.display="block",s.style.display="none",r.style.display="none",a.disabled=!0,a.classList.remove("color-orange"),u(),I(),p(),f()}),c.addEventListener("change",e=>{n.currentDay=parseInt(e.target.value),I(),localStorage.setItem("lastTrainingDay",JSON.stringify({day:n.currentDay,date:(new Date).toISOString()})),n.isRunning||(n.sessionLog=[],p())}),u(),I(),p(),function(){const e=localStorage.getItem("timerState");if(e){const t=JSON.parse(e),i=Math.floor((Date.now()-t.savedAt)/1e3);n={...t,currentTime:t.currentTime+i,interval:null},o.style.display="none",s.style.display="block",r.style.display="block",a.disabled=!1,u(),I(),p(),n.interval=setInterval(()=>{n.currentTime++,u(),f();const e=g(),t=60*e;n.currentTime>=t&&(a.classList.add("color-orange"),n.currentTime===t&&v("⏰ Sleep Timer Ready",`Check ${n.currentCheck+1} ready! Wait time of ${e} minutes reached.`))},1e3),h()}}(),T(),N(),function(){if("serviceWorker"in navigator){const e=(window.location.hostname,"./sw.js");navigator.serviceWorker.register(e).then(e=>{console.log("Service Worker registered:",e)}).catch(e=>{console.error("Service Worker registration failed:",e)})}!function(){if(!("Notification"in window))return void console.log("This browser does not support notifications");const e=Notification.permission;console.log("Notification permission status:",e),"denied"===e&&console.log("Notifications previously denied")}()}(),setTimeout(()=>{const e=document.querySelector(".view-main");e&&(e.style.visibility="visible",console.log("Main view visibility ensured"))},100),setTimeout(()=>{if(!n.isRunning){let e=0;const t=()=>{document.getElementById("splash-modal")?function(){const e=JSON.parse(localStorage.getItem("lastTrainingDay")||"{}"),t=document.getElementById("splash-modal");if(!t)return void console.log("Splash modal not found, skipping");const i=document.getElementById("splashDaySelect"),o=document.getElementById("dayHint"),s=document.getElementById("startAppBtn");if(i&&o&&s){if(e.date){const t=new Date(e.date),s=new Date,a=Math.floor((s-t)/864e5);let r=e.day||1;a>=1&&r<5&&(r=Math.min(r+a,5)),i.value=r,n.currentDay=r,o.innerHTML=0===a?`<small>Continuing from today (Day ${e.day})</small>`:1===a?`<small>Yesterday was Day ${e.day}, suggesting Day ${r}</small>`:`<small>Last session was ${a} days ago (Day ${e.day})</small>`}else o.innerHTML="<small>First time? Start with Day 1</small>";i.addEventListener("change",e=>{n.currentDay=parseInt(e.target.value);const t=document.getElementById("daySelect");t&&(t.value=e.target.value,I())}),s.addEventListener("click",()=>{localStorage.setItem("lastTrainingDay",JSON.stringify({day:n.currentDay,date:(new Date).toISOString()})),t.style.display="none"}),t.style.display="block"}else console.log("Splash modal elements not found, skipping")}():e<10?(e++,console.log(`Splash modal not found, attempt ${e}/10`),setTimeout(t,100)):console.log("Splash modal not found after 10 attempts, skipping")};t()}},1e3)});